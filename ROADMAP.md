# Sandbox-RLS Roadmap

æœ¬æ–‡æ¡£æè¿° Sandbox-RLS çš„äº§å“å®šä½ã€å¼€å‘è·¯çº¿å’ŒæŠ€æœ¯å†³ç­–ã€‚

## äº§å“å®šä½

**é¢å‘ä¸ªäººå¼€å‘è€…çš„è½»é‡çº§ AI Agent æ²™ç®±**ï¼Œæ ¸å¿ƒä»·å€¼æ˜¯ï¼š

- ğŸ¯ **ç»†ç²’åº¦æ–‡ä»¶æƒé™æ§åˆ¶**ï¼š`none/view/read/write` å››çº§æƒé™ + glob æ¨¡å¼
- ğŸš€ **è½»é‡æ˜“ç”¨**ï¼šå•æœºéƒ¨ç½²ï¼Œæ— éœ€ K8s/äº‘æœåŠ¡
- ğŸ”’ **å®‰å…¨éš”ç¦»**ï¼šè®© Agent åœ¨çœŸå®ä»£ç åº“ä¸Šå·¥ä½œï¼ŒåŒæ—¶ä¿æŠ¤æ•æ„Ÿæ–‡ä»¶

æˆ‘ä»¬**ä¸è¿½æ±‚**äº‘å‚å•†çº§åˆ«çš„ MicroVM éš”ç¦»ã€ç™¾ä¸‡å¹¶å‘ã€Serverless å¼¹æ€§ç­‰èƒ½åŠ›ã€‚

---

## å½“å‰çŠ¶æ€

### å·²å®ç° âœ…

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **ç»†ç²’åº¦æƒé™æ§åˆ¶** | FUSE æ–‡ä»¶ç³»ç»Ÿå±‚é¢çš„ `none/view/read/write` å››çº§æƒé™ |
| **Glob æ¨¡å¼åŒ¹é…** | æ”¯æŒ `**/*.py`ã€`/secrets/**` ç­‰æ¨¡å¼ |
| **bwrap éš”ç¦»** | åŸºäº bubblewrap çš„ namespace éš”ç¦» |
| **å¤šæ²™ç®±å…±äº« Codebase** | åŒä¸€ä»½ä»£ç å¯è¢«å¤šä¸ª Agent ä»¥ä¸åŒæƒé™è®¿é—® |
| **Delta Layer (COW)** | Copy-On-Write éš”ç¦»å±‚ï¼Œé˜²æ­¢å¹¶å‘å†™å†²çªï¼Œæ”¯æŒåŸå­æ€§æäº¤ |
| **Python SDK** | å®Œæ•´çš„ Python å®¢æˆ·ç«¯ |
| **gRPC + REST API** | åŒåè®®æ”¯æŒ |
| **Session æ”¯æŒ** | æœ‰çŠ¶æ€ shell sessionsï¼Œä¿æŒå·¥ä½œç›®å½•ã€ç¯å¢ƒå˜é‡ |
| **Docker Runtime** | å¯é€‰çš„ Docker éš”ç¦»ï¼Œæ”¯æŒè‡ªå®šä¹‰é•œåƒ |
| **èµ„æºé™åˆ¶** | å†…å­˜ã€CPUã€è¿›ç¨‹æ•°é™åˆ¶ |

### ä¸»è¦ç¼ºé™· âŒ

| é—®é¢˜ | å½±å“ |
|------|------|
| **bwrap éš”ç¦»è¾ƒå¼±** | ä¸é€‚åˆè¿è¡Œå®Œå…¨ä¸å¯ä¿¡çš„ä»£ç  |
| **å•æœºæ¶æ„** | æ— æ³•æ°´å¹³æ‰©å±• |

---

## å¼€å‘è·¯çº¿

### Phase 1: æ ¸å¿ƒåŠŸèƒ½å®Œå–„ âœ… å·²å®Œæˆ

è®© Sandbox èƒ½çœŸæ­£æ”¯æŒ Agent çš„æ—¥å¸¸å¼€å‘ä»»åŠ¡ã€‚

#### 1.1 Session æ”¯æŒ âœ…

**å·²å®ç°**ï¼šæœ‰çŠ¶æ€çš„ shell sessionsï¼Œæ”¯æŒå·¥ä½œç›®å½•å’Œç¯å¢ƒå˜é‡ä¿æŒã€‚

```python
# åˆ›å»º session
session = sandbox.create_session()
session.exec("cd /workspace")      # çŠ¶æ€ä¿æŒ
session.exec("npm install")        # âœ… åœ¨ /workspace æ‰§è¡Œ
session.exec("export FOO=bar")     # âœ… ç¯å¢ƒå˜é‡ä¿æŒ
session.exec("echo $FOO")          # âœ… è¾“å‡º bar
```

**å®ç°ç»†èŠ‚**ï¼š
- é•¿æœŸè¿è¡Œçš„ shell è¿›ç¨‹ï¼ˆ`/bin/bash`ï¼‰
- PTY æ”¯æŒï¼ˆç”¨äºäº¤äº’å¼å‘½ä»¤ï¼‰
- è¿›ç¨‹ç»„ç®¡ç†ï¼ˆæ¸…ç†åå°è¿›ç¨‹ï¼‰
- Session ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåˆ›å»ºã€å…³é—­ã€è‡ªåŠ¨æ¸…ç†ï¼‰

#### 1.2 èµ„æºé™åˆ¶ âœ…

**å·²å®ç°**ï¼šé€šè¿‡ Docker runtime æ”¯æŒèµ„æºé™åˆ¶ã€‚

```python
# åˆ›å»ºå¸¦èµ„æºé™åˆ¶çš„æ²™ç®±
sandbox = client.create_sandbox(
    codebase_id=codebase.id,
    resource_limits={
        "memory_bytes": 512 * 1024 * 1024,  # 512MB
        "cpu_millicores": 1000,              # 1 CPU
        "max_pids": 100,                     # æœ€å¤§è¿›ç¨‹æ•°
    }
)
```

**å®ç°ç»†èŠ‚**ï¼š
- é€šè¿‡ Docker å®¹å™¨å®ç°èµ„æºéš”ç¦»
- æ”¯æŒå†…å­˜ã€CPUã€è¿›ç¨‹æ•°é™åˆ¶
- å¯åœ¨åˆ›å»ºæ—¶æŒ‡å®š

#### 1.3 Delta Layer (COW éš”ç¦») âœ…

**å·²å®ç°**ï¼šå½“å¤šä¸ª Sandbox å…±äº«åŒä¸€ä¸ª Codebase æ—¶ï¼Œé€šè¿‡ Copy-On-Write æœºåˆ¶å®ç°å†™éš”ç¦»ã€‚

**è§£å†³çš„é—®é¢˜**ï¼š
- é˜²æ­¢ä¸­é—´çŠ¶æ€æš´éœ²ç»™å…¶ä»– Agent
- å†™æ“ä½œå¤±è´¥æ—¶å¯ä»¥å›æ»š
- ä¿è¯æ•°æ®ä¸€è‡´æ€§

**å®ç°ç»†èŠ‚**ï¼š
- è¯»å–ä¼˜å…ˆæŸ¥ Delta ç›®å½•ï¼Œfallback åˆ° Source
- å†™å…¥è‡ªåŠ¨ COW åˆ° Delta ç›®å½•
- åˆ é™¤æ“ä½œä½¿ç”¨ Whiteout æ ‡è®°
- `exec()` è¿”å›æ—¶è‡ªåŠ¨ Sync åˆ°å…±äº«å­˜å‚¨ï¼ˆLWW ç­–ç•¥ï¼‰
- å¯¹ç”¨æˆ·é€æ˜ï¼Œä¸å¢åŠ å¿ƒæ™ºè´Ÿæ‹…

```
æ—¶é—´çº¿ç¤ºä¾‹ï¼š
T=0: Agent A exec å¼€å§‹
T=1: script.py å†™å…¥ delta-A/a.txt
T=2: script.py å†™å…¥ delta-A/b.txt
T=3: script.py æ‰§è¡Œå®Œæˆ
T=4: Sync() å°† delta-A/* åˆå¹¶åˆ° sharedï¼ˆLWWï¼‰
T=5: exec è¿”å›ç»“æœç»™ Agent A
T=6: Agent B ç°åœ¨èƒ½çœ‹åˆ° a.txt å’Œ b.txt

å¦‚æœ T=2 æ—¶å´©æºƒï¼šshared storage æ— å˜åŒ–ï¼ŒAgent B çœ‹ä¸åˆ°ä»»ä½•ä¸­é—´çŠ¶æ€
```

#### 1.4 å‘½ä»¤è¶…æ—¶ä¸ç†”æ–­

**é—®é¢˜**ï¼šæ­»å¾ªç¯æˆ–é•¿æ—¶é—´è¿è¡Œçš„å‘½ä»¤ä¼šå¡ä½ç³»ç»Ÿã€‚

```python
# ç›®æ ‡
result = sandbox.exec("npm install", timeout=60)  # 60ç§’è¶…æ—¶
if result.timed_out:
    print("å‘½ä»¤è¶…æ—¶ï¼Œå·²è‡ªåŠ¨ç»ˆæ­¢")
```

---

### Phase 2: éš”ç¦»å¢å¼º + å¼€å‘è€…ä½“éªŒ

æå‡å®‰å…¨æ€§å’Œæ˜“ç”¨æ€§ã€‚

#### 2.1 Docker Runtime âœ…

**å·²å®ç°**ï¼šå®Œæ•´çš„ Docker éš”ç¦»æ”¯æŒã€‚

```python
# ä½¿ç”¨ Docker runtime
sandbox = client.create_sandbox(
    codebase_id=codebase.id,
    runtime="docker",
    image="python:3.11-slim",  # æŒ‡å®šè¿è¡Œç¯å¢ƒ
    resource_limits={
        "memory_bytes": 512 * 1024 * 1024,
        "cpu_millicores": 1000,
    }
)
```

**å®ç°ç»†èŠ‚**ï¼š
- å®ç° `runtime.Runtime` æ¥å£çš„ Docker ç‰ˆæœ¬
- æ”¯æŒè‡ªå®šä¹‰é•œåƒ
- Codebase ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨
- å®Œæ•´çš„ Session æ”¯æŒï¼ˆä¸ bwrap ä¸€è‡´ï¼‰
- å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### 2.2 ä¸€é”®å¯åŠ¨ API

**é—®é¢˜**ï¼šå½“å‰åˆ›å»ºæ²™ç®±æµç¨‹å¤ªç¹çã€‚

```python
# å½“å‰ï¼ˆç¹çï¼‰
codebase = client.create_codebase(name="test", owner_id="user1")
client.upload_file(codebase.id, "main.py", b"print('hello')")
sandbox = client.create_sandbox(codebase_id=codebase.id, permissions=[...])
client.start_sandbox(sandbox.id)

# ç›®æ ‡ï¼ˆç®€å•ï¼‰
with Sandbox.from_local("./my-project", preset="agent-safe") as sandbox:
    result = sandbox.run("python main.py")
```

#### 2.3 é¢„è®¾æƒé™æ¨¡æ¿

```python
# ç›®æ ‡ï¼šå†…ç½®å¸¸ç”¨æƒé™æ¨¡æ¿
PRESETS = {
    "agent-safe": [
        {"pattern": "**/*", "permission": "read"},
        {"pattern": "/output/**", "permission": "write"},
        {"pattern": "**/.env*", "permission": "none"},
        {"pattern": "**/secrets/**", "permission": "none"},
        {"pattern": "**/*.key", "permission": "none"},
    ],
    "read-only": [
        {"pattern": "**/*", "permission": "read"},
    ],
    "full-access": [
        {"pattern": "**/*", "permission": "write"},
    ],
}

sandbox = Sandbox.from_local("./project", preset="agent-safe")
```



## æŠ€æœ¯å†³ç­–è®°å½•

### ä¸ºä»€ä¹ˆé€‰æ‹© bwrap è€Œä¸æ˜¯ Dockerï¼Ÿ

- âœ… æ›´è½»é‡ï¼Œå¯åŠ¨æ›´å¿«
- âœ… æ— éœ€ Docker daemon
- âœ… å¯¹ FUSE æ”¯æŒæ›´å¥½
- âŒ éš”ç¦»æ€§ä¸å¦‚ Docker

**å†³ç­–**ï¼šbwrap ä½œä¸ºé»˜è®¤ runtimeï¼ŒDocker ä½œä¸ºå¯é€‰å¢å¼ºã€‚

### ä¸ºä»€ä¹ˆä¸æ”¯æŒ MicroVMï¼ˆFirecrackerï¼‰ï¼Ÿ

- éœ€è¦ `/dev/kvm` å’Œ root æƒé™
- èµ„æºå¼€é”€å¤§
- ä¸ªäººå¼€å‘è€…åœºæ™¯ä¸éœ€è¦è¿™ä¹ˆå¼ºçš„éš”ç¦»

**å†³ç­–**ï¼šä¸æ”¯æŒï¼Œè¶…å‡ºäº§å“å®šä½ã€‚

### ä¸ºä»€ä¹ˆä¸æ”¯æŒä¼‘çœ /å”¤é†’ï¼ˆCRIUï¼‰ï¼Ÿ

- æŠ€æœ¯å¤æ‚åº¦é«˜
- bwrap ä¸åŸç”Ÿæ”¯æŒ
- ä¸ªäººå¼€å‘è€…åœºæ™¯æ²™ç®±ç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œä¸éœ€è¦

**å†³ç­–**ï¼šä¸æ”¯æŒï¼Œè¶…å‡ºäº§å“å®šä½ã€‚

---

## ç‰ˆæœ¬è§„åˆ’ï¼ˆæš‚å®šï¼‰

| ç‰ˆæœ¬ | ä¸»è¦å†…å®¹ | çŠ¶æ€ |
|------|----------|------|
| v0.1 | åŸºç¡€åŠŸèƒ½ï¼šæƒé™æ§åˆ¶ã€bwrap éš”ç¦»ã€Python SDK | âœ… å·²å®Œæˆ |
| v0.2 | Session æ”¯æŒã€èµ„æºé™åˆ¶ | âœ… å·²å®Œæˆ |
| v0.3 | Docker Runtime | âœ… å·²å®Œæˆ |
| v0.4 | Delta Layerï¼ˆCOW å†™éš”ç¦»ï¼‰ | âœ… å·²å®Œæˆ |
| v0.5 | ä¸€é”®å¯åŠ¨ APIã€é¢„è®¾æ¨¡æ¿ã€CLI å·¥å…· | ğŸ“‹ è®¡åˆ’ä¸­ |
| v0.6 | Go SDKã€é…ç½®æ–‡ä»¶æ”¯æŒ | ğŸ“‹ è®¡åˆ’ä¸­ |
| v1.0 | å¤š Agent åä½œã€ç”Ÿäº§å°±ç»ª | ğŸ“‹ è®¡åˆ’ä¸­ |

---

## å‚ä¸è´¡çŒ®

æ¬¢è¿è´¡çŒ®ä»£ç ã€æ–‡æ¡£æˆ–æå‡ºå»ºè®®ï¼è¯·æŸ¥çœ‹ [Contributing Guide](CONTRIBUTING.md)ï¼ˆå¾…åˆ›å»ºï¼‰ã€‚

å¦‚æœä½ å¯¹æŸä¸ªåŠŸèƒ½ç‰¹åˆ«æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åœ¨ Issues ä¸­è®¨è®ºã€‚
