syntax = "proto3";

package sandbox.v1;

option go_package = "github.com/AjaxZhan/AgentFense/api/gen/sandbox/v1;sandboxv1";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";
import "common.proto";

// SandboxService manages sandbox lifecycle and execution
service SandboxService {
  // CreateSandbox creates a new sandbox with specified configuration
  rpc CreateSandbox(CreateSandboxRequest) returns (Sandbox) {
    option (google.api.http) = {
      post: "/v1/sandboxes"
      body: "*"
    };
  }

  // GetSandbox retrieves information about a sandbox
  rpc GetSandbox(GetSandboxRequest) returns (Sandbox) {
    option (google.api.http) = {
      get: "/v1/sandboxes/{sandbox_id}"
    };
  }

  // ListSandboxes lists all sandboxes
  rpc ListSandboxes(ListSandboxesRequest) returns (ListSandboxesResponse) {
    option (google.api.http) = {
      get: "/v1/sandboxes"
    };
  }

  // StartSandbox starts a pending sandbox
  rpc StartSandbox(StartSandboxRequest) returns (Sandbox) {
    option (google.api.http) = {
      post: "/v1/sandboxes/{sandbox_id}/start"
    };
  }

  // StopSandbox stops a running sandbox
  rpc StopSandbox(StopSandboxRequest) returns (Sandbox) {
    option (google.api.http) = {
      post: "/v1/sandboxes/{sandbox_id}/stop"
    };
  }

  // DestroySandbox destroys a sandbox and releases resources
  rpc DestroySandbox(DestroySandboxRequest) returns (Empty) {
    option (google.api.http) = {
      delete: "/v1/sandboxes/{sandbox_id}"
    };
  }

  // Exec executes a command in a sandbox
  rpc Exec(ExecRequest) returns (ExecResult) {
    option (google.api.http) = {
      post: "/v1/sandboxes/{sandbox_id}/exec"
      body: "*"
    };
  }

  // ExecStream executes a command and streams output
  rpc ExecStream(ExecRequest) returns (stream ExecOutput);

  // ============================================
  // Session Management - Stateful Shell Sessions
  // ============================================

  // CreateSession creates a new shell session within a sandbox
  rpc CreateSession(CreateSessionRequest) returns (Session) {
    option (google.api.http) = {
      post: "/v1/sandboxes/{sandbox_id}/sessions"
      body: "*"
    };
  }

  // GetSession retrieves information about a session
  rpc GetSession(GetSessionRequest) returns (Session) {
    option (google.api.http) = {
      get: "/v1/sessions/{session_id}"
    };
  }

  // ListSessions lists all sessions for a sandbox
  rpc ListSessions(ListSessionsRequest) returns (ListSessionsResponse) {
    option (google.api.http) = {
      get: "/v1/sandboxes/{sandbox_id}/sessions"
    };
  }

  // DestroySession destroys a session and kills all its child processes
  rpc DestroySession(DestroySessionRequest) returns (Empty) {
    option (google.api.http) = {
      delete: "/v1/sessions/{session_id}"
    };
  }

  // SessionExec executes a command within a session (stateful)
  rpc SessionExec(SessionExecRequest) returns (ExecResult) {
    option (google.api.http) = {
      post: "/v1/sessions/{session_id}/exec"
      body: "*"
    };
  }

  // SessionExecStream executes a command within a session and streams output
  rpc SessionExecStream(SessionExecRequest) returns (stream ExecOutput);
}

// RuntimeType specifies the sandbox runtime implementation
enum RuntimeType {
  RUNTIME_TYPE_UNSPECIFIED = 0;
  RUNTIME_TYPE_BWRAP = 1;
  RUNTIME_TYPE_DOCKER = 2;
}

// ResourceLimits defines resource constraints for a sandbox
message ResourceLimits {
  int64 memory_bytes = 1;  // Memory limit in bytes (e.g., 512*1024*1024 for 512MB)
  int64 cpu_quota = 2;     // CPU quota in microseconds per 100ms period
  int64 cpu_shares = 3;    // CPU shares (relative weight)
  int64 pids_limit = 4;    // Maximum number of processes
}

// Sandbox represents an isolated execution environment
message Sandbox {
  string id = 1;
  string codebase_id = 2;
  repeated PermissionRule permissions = 3;
  SandboxStatus status = 4;
  map<string, string> labels = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp started_at = 7;
  google.protobuf.Timestamp stopped_at = 8;
  google.protobuf.Timestamp expires_at = 9;
  // Runtime configuration
  RuntimeType runtime = 10;       // Runtime type used
  string image = 11;              // Docker image (for docker runtime)
  ResourceLimits resources = 12;  // Resource limits
}

// CreateSandboxRequest
message CreateSandboxRequest {
  string codebase_id = 1;
  repeated PermissionRule permissions = 2;
  google.protobuf.Duration expires_in = 3;
  map<string, string> labels = 4;
  // Runtime configuration
  RuntimeType runtime = 5;       // Runtime type: bwrap, docker
  string image = 6;              // Docker image (for docker runtime)
  ResourceLimits resources = 7;  // Resource limits
}

// GetSandboxRequest
message GetSandboxRequest {
  string sandbox_id = 1;
}

// ListSandboxesRequest
message ListSandboxesRequest {
  string codebase_id = 1; // Optional filter by codebase
  int32 page_size = 2;
  string page_token = 3;
}

// ListSandboxesResponse
message ListSandboxesResponse {
  repeated Sandbox sandboxes = 1;
  string next_page_token = 2;
}

// StartSandboxRequest
message StartSandboxRequest {
  string sandbox_id = 1;
}

// StopSandboxRequest
message StopSandboxRequest {
  string sandbox_id = 1;
}

// DestroySandboxRequest
message DestroySandboxRequest {
  string sandbox_id = 1;
}

// ExecRequest represents a command execution request
message ExecRequest {
  string sandbox_id = 1;
  string command = 2;
  string stdin = 3;
  map<string, string> env = 4;
  string workdir = 5;
  google.protobuf.Duration timeout = 6;
}

// ExecResult represents the result of command execution
message ExecResult {
  string stdout = 1;
  string stderr = 2;
  int32 exit_code = 3;
  google.protobuf.Duration duration = 4;
}

// ExecOutput represents a chunk of streaming output
message ExecOutput {
  enum OutputType {
    OUTPUT_TYPE_UNSPECIFIED = 0;
    OUTPUT_TYPE_STDOUT = 1;
    OUTPUT_TYPE_STDERR = 2;
  }
  OutputType type = 1;
  bytes data = 2;
}

// ============================================
// Session Messages
// ============================================

// Session represents a stateful shell session within a sandbox
message Session {
  string id = 1;
  string sandbox_id = 2;
  SessionStatus status = 3;
  string shell = 4;  // Shell binary, e.g., "/bin/bash"
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp closed_at = 6;
}

// CreateSessionRequest
message CreateSessionRequest {
  string sandbox_id = 1;
  string shell = 2;  // Optional: shell binary (default: /bin/bash)
  map<string, string> env = 3;  // Optional: initial environment variables
}

// GetSessionRequest
message GetSessionRequest {
  string session_id = 1;
}

// ListSessionsRequest
message ListSessionsRequest {
  string sandbox_id = 1;
}

// ListSessionsResponse
message ListSessionsResponse {
  repeated Session sessions = 1;
}

// DestroySessionRequest
message DestroySessionRequest {
  string session_id = 1;
}

// SessionExecRequest represents a command execution within a session
message SessionExecRequest {
  string session_id = 1;
  string command = 2;
  google.protobuf.Duration timeout = 3;
}
